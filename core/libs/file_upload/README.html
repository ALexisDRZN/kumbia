<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileUpload - Guía de Uso</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1, h2 { color: #333; }
        code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .example { border-left: 4px solid #007cba; padding-left: 15px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>FileUpload - Clase para Subida de Archivos</h1>
    
    <h2>Descripción</h2>
    <p>Clase para manejar la subida de archivos asociados a modelos de KumbiaPHP. Los archivos se almacenan en <code>storage/:model_class_name/:id.extension</code></p>

    <h2>Tipos de Archivos Soportados</h2>
    <ul>
        <li><strong>Imágenes:</strong> JPG, JPEG, PNG, GIF, WebP</li>
        <li><strong>Documentos:</strong> PDF</li>
        <li><strong>Otros:</strong> Cualquier tipo de archivo (con validación manual)</li>
    </ul>

    <h2>Métodos Disponibles</h2>
    
    <h3>upload($file, $instance)</h3>
    <p>Sube un archivo asociado a una instancia de modelo. El nombre del archivo será el ID del modelo con la extensión original.</p>
    <div class="example">
        <pre><code>// En el controlador
$fruta = new Fruta();
$fruta->nombre = 'Manzana';
$fruta->save(); // Necesita ID primero

if (isset($_FILES['imagen'])) {
    $ruta = FileUpload::upload($_FILES['imagen'], $fruta);
    if ($ruta) {
        Flash::valid('Imagen subida correctamente');
    } else {
        Flash::error('Error al subir imagen');
    }
}</code></pre>
    </div>

    <h3>getUrl($instance)</h3>
    <p>Obtiene la URL pública del archivo para mostrar en vistas.</p>
    <div class="example">
        <pre><code>// En la vista
$fruta = new Fruta();
$fruta->find(1);

$urlImagen = FileUpload::getUrl($fruta);
if ($urlImagen) {
    echo '&lt;img src="' . $urlImagen . '" alt="Imagen de fruta"&gt;';
}</code></pre>
    </div>

    <h3>exists($instance)</h3>
    <p>Verifica si existe un archivo.</p>
    <div class="example">
        <pre><code>if (FileUpload::exists($fruta)) {
    echo 'La fruta tiene imagen';
} else {
    echo 'Sin imagen disponible';
}</code></pre>
    </div>

    <h3>delete($instance)</h3>
    <p>Elimina un archivo del storage.</p>
    <div class="example">
        <pre><code>if (FileUpload::delete($fruta)) {
    Flash::valid('Imagen eliminada');
} else {
    Flash::error('Error al eliminar imagen');
}</code></pre>
    </div>

    <h2>Ejemplo Completo - Controlador</h2>
    <div class="example">
        <pre><code>class FrutasController extends AppController
{
    public function crear()
    {
        if (Input::hasPost('nombre')) {
            $fruta = new Fruta();
            $fruta->nombre = Input::post('nombre');
            
            if ($fruta->save()) {
                // Subir archivo (imagen, PDF, etc.)
                if (isset($_FILES['archivo']) && $_FILES['archivo']['error'] === UPLOAD_ERR_OK) {
                    $ruta = FileUpload::upload($_FILES['archivo'], $fruta);
                    if ($ruta) {
                        Flash::info('Archivo subido correctamente');
                    } else {
                        Flash::error('Error al subir archivo');
                    }
                }
                
                Flash::valid('Fruta creada exitosamente');
                Router::redirect('/frutas');
            }
        }
    }
    
    public function eliminar($id)
    {
        $fruta = new Fruta();
        if ($fruta->find($id)) {
            // Eliminar archivo antes de eliminar registro
            FileUpload::delete($fruta);
            
            if ($fruta->delete()) {
                Flash::valid('Fruta eliminada');
            }
        }
        Router::redirect('/frutas');
    }
}</code></pre>
    </div>

    <h2>Ejemplo Completo - Vista (Formulario)</h2>
    <div class="example">
        <pre><code>&lt;?= Form::open('frutas/crear', 'post', ['enctype' =&gt; 'multipart/form-data']) ?&gt;
    &lt;div class="mb-3"&gt;
        &lt;?= Form::label('nombre', 'Nombre:', ['class' =&gt; 'form-label']) ?&gt;
        &lt;?= Form::text('nombre', ['class' =&gt; 'form-control']) ?&gt;
    &lt;/div&gt;
    
    &lt;!-- Subir Archivo (Imagen o PDF) --&gt;
    &lt;div class="mb-3"&gt;
        &lt;?= Form::label('archivo', 'Archivo:', ['class' =&gt; 'form-label']) ?&gt;
        &lt;?= Form::file('archivo', [
            'class' =&gt; 'form-control', 
            'accept' =&gt; 'image/*,application/pdf'
        ]) ?&gt;
        &lt;div class="form-text"&gt;Formatos: JPG, PNG, GIF, WebP, PDF&lt;/div&gt;
    &lt;/div&gt;
    
    &lt;?= Form::submit('Guardar', ['class' =&gt; 'btn btn-primary']) ?&gt;
&lt;?= Form::close() ?&gt;</code></pre>
    </div>

    <h2>Ejemplo Completo - Vista (Mostrar Archivos)</h2>
    <div class="example">
        <pre><code>&lt;?php foreach ($frutas as $fruta): ?&gt;
    &lt;div class="card"&gt;
        &lt;?php if (FileUpload::exists($fruta)): ?&gt;
            &lt;?php $url = FileUpload::getUrl($fruta); ?&gt;
            &lt;?php $extension = pathinfo($url, PATHINFO_EXTENSION); ?&gt;
            
            &lt;!-- Mostrar imagen si es imagen --&gt;
            &lt;?php if (in_array(strtolower($extension), ['jpg', 'jpeg', 'png', 'gif', 'webp'])): ?&gt;
                &lt;img src="&lt;?= $url ?&gt;" class="card-img-top" alt="&lt;?= $fruta-&gt;nombre ?&gt;" 
                     style="height: 200px; object-fit: cover;"&gt;
            &lt;!-- Mostrar enlace si es PDF --&gt;
            &lt;?php elseif (strtolower($extension) === 'pdf'): ?&gt;
                &lt;div class="card-img-top bg-light text-center p-4" style="height: 200px;"&gt;
                    &lt;i class="fas fa-file-pdf fa-3x text-danger"&gt;&lt;/i&gt;
                    &lt;p class="mt-2"&gt;
                        &lt;a href="&lt;?= $url ?&gt;" target="_blank" class="btn btn-outline-primary"&gt;
                            Ver PDF
                        &lt;/a&gt;
                    &lt;/p&gt;
                &lt;/div&gt;
            &lt;?php endif; ?&gt;
        &lt;?php else: ?&gt;
            &lt;div class="card-img-top bg-light text-center p-4" style="height: 200px;"&gt;
                &lt;i class="fas fa-file fa-3x text-muted"&gt;&lt;/i&gt;
                &lt;p class="mt-2 text-muted"&gt;Sin archivo&lt;/p&gt;
            &lt;/div&gt;
        &lt;?php endif; ?&gt;
        
        &lt;div class="card-body"&gt;
            &lt;h5 class="card-title"&gt;&lt;?= $fruta-&gt;nombre ?&gt;&lt;/h5&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;?php endforeach; ?&gt;</code></pre>
    </div>

    <h2>Ejemplo - Vista Detalle con Previsualización</h2>
    <div class="example">
        <pre><code>&lt;div class="container"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-md-6"&gt;
            &lt;!-- Imagen Principal --&gt;
            &lt;?php if (FileUpload::exists($fruta, 'imagen')): ?&gt;
                &lt;img src="&lt;?= FileUpload::getUrl($fruta, 'imagen') ?&gt;" 
                     class="img-fluid rounded" alt="&lt;?= $fruta-&gt;nombre ?&gt;"&gt;
            &lt;?php else: ?&gt;
                &lt;div class="bg-light text-center p-5 rounded"&gt;
                    &lt;i class="fas fa-image fa-5x text-muted"&gt;&lt;/i&gt;
                    &lt;p class="mt-3 text-muted"&gt;Sin imagen disponible&lt;/p&gt;
                &lt;/div&gt;
            &lt;?php endif; ?&gt;
        &lt;/div&gt;
        
        &lt;div class="col-md-6"&gt;
            &lt;h1&gt;&lt;?= $fruta-&gt;nombre ?&gt;&lt;/h1&gt;
            
            &lt;!-- Documentos Disponibles --&gt;
            &lt;h3&gt;Documentos&lt;/h3&gt;
            &lt;div class="list-group"&gt;
                &lt;?php if (FileUpload::exists($fruta, 'ficha_tecnica')): ?&gt;
                    &lt;a href="&lt;?= FileUpload::getUrl($fruta, 'ficha_tecnica') ?&gt;" 
                       class="list-group-item list-group-item-action" target="_blank"&gt;
                        &lt;i class="fas fa-file-pdf text-danger"&gt;&lt;/i&gt;
                        &lt;strong&gt;Ficha Técnica&lt;/strong&gt;
                        &lt;small class="text-muted d-block"&gt;Información nutricional y características&lt;/small&gt;
                    &lt;/a&gt;
                &lt;?php endif; ?&gt;
                
                &lt;?php if (FileUpload::exists($fruta, 'certificado')): ?&gt;
                    &lt;a href="&lt;?= FileUpload::getUrl($fruta, 'certificado') ?&gt;" 
                       class="list-group-item list-group-item-action" target="_blank"&gt;
                        &lt;i class="fas fa-certificate text-success"&gt;&lt;/i&gt;
                        &lt;strong&gt;Certificado Orgánico&lt;/strong&gt;
                        &lt;small class="text-muted d-block"&gt;Certificación de producto orgánico&lt;/small&gt;
                    &lt;/a&gt;
                &lt;?php endif; ?&gt;
                
                &lt;?php if (!FileUpload::exists($fruta, 'ficha_tecnica') && !FileUpload::exists($fruta, 'certificado')): ?&gt;
                    &lt;div class="list-group-item"&gt;
                        &lt;i class="fas fa-info-circle text-muted"&gt;&lt;/i&gt;
                        No hay documentos disponibles
                    &lt;/div&gt;
                &lt;?php endif; ?&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
    </div>

    <h2>Estructura de Archivos</h2>
    <p>Los archivos se almacenan en:</p>
    <pre><code>public/storage/
├── fruta/
│   ├── 1.jpg
│   ├── 2.png
│   ├── 3.pdf
│   └── 5.webp
└── usuario/
    ├── 10.jpg
    ├── 15.png
    └── 20.pdf</code></pre>

    <h2>Validación de Archivos (Ejemplo Avanzado)</h2>
    <div class="example">
        <pre><code>// En el controlador - Validación antes de subir
public function crear()
{
    if (Input::hasPost('nombre')) {
        $fruta = new Fruta();
        $fruta->nombre = Input::post('nombre');
        
        if ($fruta->save()) {
            // Validar y subir archivo
            if (isset($_FILES['archivo']) && $_FILES['archivo']['error'] === UPLOAD_ERR_OK) {
                $allowedTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf'];
                $fileExt = strtolower(pathinfo($_FILES['archivo']['name'], PATHINFO_EXTENSION));
                $maxSize = in_array($fileExt, ['jpg', 'jpeg', 'png', 'gif', 'webp']) ? 5000000 : 10000000; // 5MB imágenes, 10MB PDFs
                
                if (in_array($fileExt, $allowedTypes) && $_FILES['archivo']['size'] <= $maxSize) {
                    if (FileUpload::upload($_FILES['archivo'], $fruta)) {
                        Flash::valid('Archivo subido correctamente');
                    } else {
                        Flash::error('Error al subir archivo');
                    }
                } else {
                    Flash::error('Archivo inválido. Solo JPG, PNG, GIF, WebP (5MB) o PDF (10MB)');
                }
            }
        }
    }
}</code></pre>
    </div>

    <h2>Notas Importantes</h2>
    <ul>
        <li>El modelo debe tener un <code>id</code> antes de subir archivos</li>
        <li>Los formularios deben incluir <code>enctype="multipart/form-data"</code></li>
        <li>La clase maneja automáticamente las extensiones de archivo</li>
        <li>Solo se puede subir un archivo por modelo (se reemplaza si existe)</li>
        <li>Los directorios se crean automáticamente</li>
        <li><strong>Archivos soportados:</strong> JPG, PNG, GIF, WebP (5MB), PDF (10MB)</li>
        <li>El nombre del archivo será el ID del modelo + extensión original</li>
        <li>Usar <code>target="_blank"</code> para abrir PDFs en nueva pestaña</li>
        <li>Validar siempre el tipo y tamaño de archivo antes de subir</li>
        <li>Los archivos son públicamente accesibles vía URL</li>
        <li>Subir un nuevo archivo reemplaza el anterior automáticamente</li>
    </ul>
</body>
</html>